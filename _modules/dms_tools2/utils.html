
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>dms_tools2.utils &#8212; dms_tools2 2.6.3 documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for dms_tools2.utils</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">===================</span>
<span class="sd">utils</span>
<span class="sd">===================</span>

<span class="sd">Miscellaneous utilities for ``dms_tools2``.</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">import</span> <span class="nn">importlib</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">textwrap</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="kn">import</span> <span class="nn">pysam</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">scipy.misc</span>
<span class="kn">import</span> <span class="nn">scipy.special</span>
<span class="kn">import</span> <span class="nn">pandas</span>
<span class="kn">import</span> <span class="nn">gzip</span>

<span class="kn">import</span> <span class="nn">dms_variants.codonvarianttable</span>

<span class="kn">import</span> <span class="nn">dms_tools2</span>
<span class="kn">from</span> <span class="nn">dms_tools2</span> <span class="k">import</span> <span class="n">CODONS</span><span class="p">,</span> <span class="n">CODON_TO_AA</span><span class="p">,</span> <span class="n">AAS_WITHSTOP</span><span class="p">,</span> <span class="n">AA_TO_CODONS</span><span class="p">,</span> <span class="n">NTS</span>
<span class="kn">import</span> <span class="nn">dms_tools2._cutils</span>


<div class="viewcode-block" id="sessionInfo"><a class="viewcode-back" href="../../dms_tools2.utils.html#dms_tools2.utils.sessionInfo">[docs]</a><span class="k">def</span> <span class="nf">sessionInfo</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Returns string with information about session / packages.&quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;Version information:&#39;</span><span class="p">,</span>
            <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Time and date: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">asctime</span><span class="p">()),</span>
            <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Platform: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">platform</span><span class="o">.</span><span class="n">platform</span><span class="p">()),</span>
            <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Python version: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)),</span>
            <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">dms_tools2 version: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dms_tools2</span><span class="o">.</span><span class="n">__version__</span><span class="p">),</span>
            <span class="p">]</span>
    <span class="k">for</span> <span class="n">modname</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Bio&#39;</span><span class="p">,</span> <span class="s1">&#39;pandas&#39;</span><span class="p">,</span> <span class="s1">&#39;numpy&#39;</span><span class="p">,</span> <span class="s1">&#39;IPython&#39;</span><span class="p">,</span>
            <span class="s1">&#39;jupyter&#39;</span><span class="p">,</span> <span class="s1">&#39;matplotlib&#39;</span><span class="p">,</span> <span class="s1">&#39;plotnine&#39;</span><span class="p">,</span> <span class="s1">&#39;natsort&#39;</span><span class="p">,</span> <span class="s1">&#39;pystan&#39;</span><span class="p">,</span>
            <span class="s1">&#39;scipy&#39;</span><span class="p">,</span> <span class="s1">&#39;seaborn&#39;</span><span class="p">,</span> <span class="s1">&#39;phydmslib&#39;</span><span class="p">,</span> <span class="s1">&#39;statsmodels&#39;</span><span class="p">,</span> <span class="s1">&#39;rpy2&#39;</span><span class="p">,</span>
            <span class="s1">&#39;regex&#39;</span><span class="p">,</span> <span class="s1">&#39;umi_tools&#39;</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">modname</span><span class="p">)</span><span class="o">.</span><span class="n">__version__</span>
            <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">{0}</span><span class="s1"> version: </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">modname</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">{0}</span><span class="s1"> version unknown&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">modname</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{0}</span><span class="s2"> cannot be imported&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">modname</span><span class="p">))</span>
    <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span><span class="p">)</span></div>


<div class="viewcode-block" id="initLogger"><a class="viewcode-back" href="../../dms_tools2.utils.html#dms_tools2.utils.initLogger">[docs]</a><span class="k">def</span> <span class="nf">initLogger</span><span class="p">(</span><span class="n">logfile</span><span class="p">,</span> <span class="n">prog</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Initialize output logging for scripts.</span>

<span class="sd">    Args:</span>
<span class="sd">        `logfile` (str or `sys.stdout`)</span>
<span class="sd">            Name of file to which log is written, or </span>
<span class="sd">            `sys.stdout` if you just want to write information</span>
<span class="sd">            to standard output.</span>
<span class="sd">        `prog` (str)</span>
<span class="sd">            Name of program for which we are logging.</span>
<span class="sd">        `args` (dict)</span>
<span class="sd">            Program arguments as arg / value pairs.</span>

<span class="sd">    Returns:</span>
<span class="sd">        If `logfile` is a string giving a file name, returns</span>
<span class="sd">        an opened and initialized `logging.Logger`. If `logfile`</span>
<span class="sd">        is `sys.stdout`, then writes information to `sys.stdout`.</span>
<span class="sd">        In either case, basic information is written about the program </span>
<span class="sd">        and args.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">logfile</span> <span class="o">==</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">:</span>
        <span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Beginning execution of </span><span class="si">{0}</span><span class="s2"> in directory </span><span class="si">{1}</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">prog</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()))</span>
        <span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sessionInfo</span><span class="p">()))</span>
        <span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Parsed the following arguments:</span><span class="se">\n\t</span><span class="si">{0}</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> = </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
                <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">items</span><span class="p">()])))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">logfile</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">logfile</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
                <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">prog</span><span class="p">)</span>
        <span class="n">logfile_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="n">logfile</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">logfile_handler</span><span class="p">)</span>
        <span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span>
                <span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">logfile_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Beginning execution of </span><span class="si">{0}</span><span class="s2"> in directory </span><span class="si">{1}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prog</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Progress is being logged to </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logfile</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sessionInfo</span><span class="p">()))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Parsed the following arguments:</span><span class="se">\n\t</span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> = </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
                    <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">items</span><span class="p">()])))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Error&quot;</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="k">return</span> <span class="n">logger</span></div>


<div class="viewcode-block" id="iteratePairedFASTQ"><a class="viewcode-back" href="../../dms_tools2.utils.html#dms_tools2.utils.iteratePairedFASTQ">[docs]</a><span class="k">def</span> <span class="nf">iteratePairedFASTQ</span><span class="p">(</span><span class="n">r1files</span><span class="p">,</span> <span class="n">r2files</span><span class="p">,</span> <span class="n">r1trim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">r2trim</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Iterates over FASTQ files for single or paired-end sequencing.</span>

<span class="sd">    Args:</span>
<span class="sd">        `r1files` (list or str)</span>
<span class="sd">            Name of R1 FASTQ file or list of such files. Can optionally</span>
<span class="sd">            be gzipped.</span>
<span class="sd">        `r2files` (list or str or `None`)</span>
<span class="sd">            Like `r1files` but for R2 files, or `None` if no R2.</span>
<span class="sd">        `r1trim` (int or `None`)</span>
<span class="sd">            If not `None`, trim `r1` and `q1` to be no longer than this.</span>
<span class="sd">        `r2trim` (int or `None`)</span>
<span class="sd">            Like `r1trim` but for R2.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Each iteration returns `(name, r1, r2, q1, q2, fail)` where:</span>

<span class="sd">            - `name` is a string giving the read name</span>

<span class="sd">            - `r1` and `r2` are strings giving the reads; `r2`</span>
<span class="sd">              is `None` if no R2.</span>

<span class="sd">            - `q1` and `q2` are strings giving the PHRED Q scores;</span>
<span class="sd">              `q2` is none if no R2.</span>

<span class="sd">            - `fail` is `True` if either read failed Illumina chastity</span>
<span class="sd">              filter, `False` if both passed, `None` if info not present.</span>

<span class="sd">    We run a simple test by first writing an example FASTQ file and</span>
<span class="sd">    then testing on it.</span>

<span class="sd">    &gt;&gt;&gt; n1_1 = &#39;@DH1DQQN1:933:HMLH5BCXY:1:1101:2165:1984 1:N:0:CGATGT&#39;</span>
<span class="sd">    &gt;&gt;&gt; r1_1 = &#39;ATGCAATTG&#39;</span>
<span class="sd">    &gt;&gt;&gt; q1_1 = &#39;GGGGGIIII&#39;</span>
<span class="sd">    &gt;&gt;&gt; n2_1 = &#39;@DH1DQQN1:933:HMLH5BCXY:1:1101:2165:1984 2:N:0:CGATGT&#39;</span>
<span class="sd">    &gt;&gt;&gt; r2_1 = &#39;CATGCATA&#39;</span>
<span class="sd">    &gt;&gt;&gt; q2_1 = &#39;G&lt;GGGIII&#39;</span>
<span class="sd">    &gt;&gt;&gt; tf = tempfile.NamedTemporaryFile</span>
<span class="sd">    &gt;&gt;&gt; with tf(mode=&#39;w&#39;) as r1file, tf(mode=&#39;w&#39;) as r2file:</span>
<span class="sd">    ...     _ = r1file.write(&#39;\\n&#39;.join([</span>
<span class="sd">    ...             n1_1, r1_1, &#39;+&#39;, q1_1,</span>
<span class="sd">    ...             n1_1.replace(&#39;:N:&#39;, &#39;:Y:&#39;), r1_1, &#39;+&#39;, q1_1,</span>
<span class="sd">    ...             n1_1.split()[0], r1_1, &#39;+&#39;, q1_1,</span>
<span class="sd">    ...             ]))</span>
<span class="sd">    ...     r1file.flush()</span>
<span class="sd">    ...     _ = r2file.write(&#39;\\n&#39;.join([</span>
<span class="sd">    ...             n2_1, r2_1, &#39;+&#39;, q2_1,</span>
<span class="sd">    ...             n2_1, r2_1, &#39;+&#39;, q2_1,</span>
<span class="sd">    ...             n2_1, r2_1, &#39;+&#39;, q2_1,</span>
<span class="sd">    ...             ]))</span>
<span class="sd">    ...     r2file.flush()</span>
<span class="sd">    ...     itr = iteratePairedFASTQ(r1file.name, r2file.name, r1trim=4, r2trim=5)</span>
<span class="sd">    ...     next(itr) == (n1_1.split()[0][1 : ], r1_1[ : 4],</span>
<span class="sd">    ...             r2_1[ : 5], q1_1[ : 4], q2_1[ : 5], False)</span>
<span class="sd">    ...     next(itr) == (n1_1.split()[0][1 : ], r1_1[ : 4],</span>
<span class="sd">    ...             r2_1[ : 5], q1_1[ : 4], q2_1[ : 5], True)</span>
<span class="sd">    ...     next(itr) == (n1_1.split()[0][1 : ], r1_1[ : 4],</span>
<span class="sd">    ...             r2_1[ : 5], q1_1[ : 4], q2_1[ : 5], None)</span>
<span class="sd">    True</span>
<span class="sd">    True</span>
<span class="sd">    True</span>

<span class="sd">    Now do the same test but for just R1:</span>

<span class="sd">    &gt;&gt;&gt; with tf(mode=&#39;w&#39;) as r1file:</span>
<span class="sd">    ...     _ = r1file.write(&#39;\\n&#39;.join([</span>
<span class="sd">    ...             n1_1, r1_1, &#39;+&#39;, q1_1,</span>
<span class="sd">    ...             n1_1.replace(&#39;:N:&#39;, &#39;:Y:&#39;), r1_1, &#39;+&#39;, q1_1,</span>
<span class="sd">    ...             n1_1.split()[0], r1_1, &#39;+&#39;, q1_1,</span>
<span class="sd">    ...             ]))</span>
<span class="sd">    ...     r1file.flush()</span>
<span class="sd">    ...     itr_R1 = iteratePairedFASTQ(r1file.name, None, r1trim=4)</span>
<span class="sd">    ...     next(itr_R1) == (n1_1.split()[0][1 : ], r1_1[ : 4],</span>
<span class="sd">    ...             None, q1_1[ : 4], None, False)</span>
<span class="sd">    ...     next(itr_R1) == (n1_1.split()[0][1 : ], r1_1[ : 4],</span>
<span class="sd">    ...             None, q1_1[ : 4], None, True)</span>
<span class="sd">    ...     next(itr_R1) == (n1_1.split()[0][1 : ], r1_1[ : 4],</span>
<span class="sd">    ...             None, q1_1[ : 4], None, None)</span>
<span class="sd">    True</span>
<span class="sd">    True</span>
<span class="sd">    True</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">r1files</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">r1files</span> <span class="o">=</span> <span class="p">[</span><span class="n">r1files</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">r2files</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">r2files</span> <span class="o">=</span> <span class="p">[</span><span class="n">r2files</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">,</span> <span class="n">r1files</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;cannot find all `r1files`&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">r2files</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">r2files</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">r1files</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">r1files</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">r2files</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;`r1files` and `r2files` differ in length&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">,</span> <span class="n">r2files</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;cannot find all `r2files`&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">r1file</span><span class="p">,</span> <span class="n">r2file</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">r1files</span><span class="p">,</span> <span class="n">r2files</span><span class="p">):</span>
        <span class="n">r1reader</span> <span class="o">=</span> <span class="n">pysam</span><span class="o">.</span><span class="n">FastxFile</span><span class="p">(</span><span class="n">r1file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">r2file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">read_iterator</span> <span class="o">=</span> <span class="n">r1reader</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">r2reader</span> <span class="o">=</span> <span class="n">pysam</span><span class="o">.</span><span class="n">FastxFile</span><span class="p">(</span><span class="n">r2file</span><span class="p">)</span>
            <span class="n">read_iterator</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">r1reader</span><span class="p">,</span> <span class="n">r2reader</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">read_iterator</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">r2file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
               <span class="n">a1</span> <span class="o">=</span> <span class="n">tup</span>
               <span class="n">r2</span> <span class="o">=</span> <span class="n">q2</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span> <span class="o">=</span> <span class="n">tup</span>
                <span class="n">r2</span> <span class="o">=</span> <span class="n">a2</span><span class="o">.</span><span class="n">sequence</span>
                <span class="n">q2</span> <span class="o">=</span> <span class="n">a2</span><span class="o">.</span><span class="n">quality</span>
                <span class="k">if</span> <span class="n">a2</span><span class="o">.</span><span class="n">comment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">id2</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;</span><span class="si">{a2.name}</span><span class="s2"> </span><span class="si">{a2.comment}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">id2</span> <span class="o">=</span> <span class="n">a2</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">name2</span> <span class="o">=</span> <span class="n">id2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">r1</span> <span class="o">=</span> <span class="n">a1</span><span class="o">.</span><span class="n">sequence</span>
            <span class="n">q1</span> <span class="o">=</span> <span class="n">a1</span><span class="o">.</span><span class="n">quality</span>
            <span class="k">if</span> <span class="n">a1</span><span class="o">.</span><span class="n">comment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">id1</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;</span><span class="si">{a1.name}</span><span class="s2"> </span><span class="si">{a1.comment}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">id1</span> <span class="o">=</span> <span class="n">a1</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">name1</span> <span class="o">=</span> <span class="n">id1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">r2file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># trims last two chars, need for SRA downloaded files</span>
                <span class="k">if</span> <span class="n">name1</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span> <span class="p">:</span> <span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;.1&#39;</span> <span class="ow">and</span> <span class="n">name2</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span> <span class="p">:</span> <span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;.2&#39;</span><span class="p">:</span>
                    <span class="n">name1</span> <span class="o">=</span> <span class="n">name1</span><span class="p">[</span> <span class="p">:</span> <span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">name2</span> <span class="o">=</span> <span class="n">name2</span><span class="p">[</span> <span class="p">:</span> <span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">name1</span> <span class="o">!=</span> <span class="n">name2</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;name mismatch </span><span class="si">{name1}</span><span class="s2"> vs </span><span class="si">{name2}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># parse chastity filter assuming CASAVA 1.8 header</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">f1</span> <span class="o">=</span> <span class="n">id1</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">r2file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">f2</span> <span class="o">=</span> <span class="s1">&#39;N&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">f2</span> <span class="o">=</span> <span class="n">id2</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">f1</span> <span class="o">==</span> <span class="s1">&#39;N&#39;</span> <span class="ow">and</span> <span class="n">f2</span> <span class="o">==</span> <span class="s1">&#39;N&#39;</span><span class="p">:</span>
                    <span class="n">fail</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">elif</span> <span class="n">f1</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">f2</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">]:</span>
                    <span class="n">fail</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="n">fail</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># header does not specify chastity filter</span>
            <span class="k">if</span> <span class="n">r1trim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">r1</span> <span class="o">=</span> <span class="n">r1</span><span class="p">[</span> <span class="p">:</span> <span class="n">r1trim</span><span class="p">]</span>
                <span class="n">q1</span> <span class="o">=</span> <span class="n">q1</span><span class="p">[</span> <span class="p">:</span> <span class="n">r1trim</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">r2trim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">r2file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">r2</span> <span class="o">=</span> <span class="n">r2</span><span class="p">[</span> <span class="p">:</span> <span class="n">r2trim</span><span class="p">]</span>
                <span class="n">q2</span> <span class="o">=</span> <span class="n">q2</span><span class="p">[</span> <span class="p">:</span> <span class="n">r2trim</span><span class="p">]</span>
            <span class="k">yield</span> <span class="p">(</span><span class="n">name1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">q1</span><span class="p">,</span> <span class="n">q2</span><span class="p">,</span> <span class="n">fail</span><span class="p">)</span></div>


<div class="viewcode-block" id="lowQtoN"><a class="viewcode-back" href="../../dms_tools2.utils.html#dms_tools2.utils.lowQtoN">[docs]</a><span class="k">def</span> <span class="nf">lowQtoN</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">minq</span><span class="p">,</span> <span class="n">use_cutils</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Replaces low quality nucleotides with ``N`` characters.</span>

<span class="sd">    Args:</span>
<span class="sd">        `r` (str)</span>
<span class="sd">            A string representing a sequencing read.</span>
<span class="sd">        `q` (str)</span>
<span class="sd">            String of same length as `r` holding Q scores</span>
<span class="sd">            in Sanger ASCII encoding.</span>
<span class="sd">        `minq` (length-one string)</span>
<span class="sd">            Replace all positions in `r` where `q` is &lt; this.</span>
<span class="sd">        `use_cutils` (bool)</span>
<span class="sd">            Use the faster implementation in the `_cutils` module.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A version of `r` where all positions `i` where </span>
<span class="sd">        `q[i] &lt; minq` have been replaced with ``N``.</span>

<span class="sd">    &gt;&gt;&gt; r = &#39;ATGCAT&#39;</span>
<span class="sd">    &gt;&gt;&gt; q = &#39;GB&lt;.0+&#39;</span>
<span class="sd">    &gt;&gt;&gt; minq = &#39;0&#39;</span>
<span class="sd">    &gt;&gt;&gt; lowQtoN(r, q, minq) == &#39;ATGNAN&#39;</span>
<span class="sd">    True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">use_cutils</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dms_tools2</span><span class="o">.</span><span class="n">_cutils</span><span class="o">.</span><span class="n">lowQtoN</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">minq</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">ri</span> <span class="k">if</span> <span class="n">qi</span> <span class="o">&gt;=</span> <span class="n">minq</span> <span class="k">else</span> <span class="s1">&#39;N&#39;</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">ri</span><span class="p">,</span> <span class="n">qi</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">q</span><span class="p">)])</span></div>


<div class="viewcode-block" id="buildReadConsensus"><a class="viewcode-back" href="../../dms_tools2.utils.html#dms_tools2.utils.buildReadConsensus">[docs]</a><span class="k">def</span> <span class="nf">buildReadConsensus</span><span class="p">(</span><span class="n">reads</span><span class="p">,</span> <span class="n">minreads</span><span class="p">,</span> <span class="n">minconcur</span><span class="p">,</span> <span class="n">use_cutils</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Builds consensus sequence of some reads.</span>

<span class="sd">    You may want to pre-fill low-quality sites with ``N``</span>
<span class="sd">    using `lowQtoN`. An ``N`` is considered a non-called identity.</span>

<span class="sd">    Args:</span>
<span class="sd">        `reads` (list)</span>
<span class="sd">            List of reads as strings. If reads are not all same</span>
<span class="sd">            length, shorter ones are extended from 3&#39; end with ``N``</span>
<span class="sd">            to match maximal length. </span>
<span class="sd">        `minreads` (int)</span>
<span class="sd">            Only call consensus at a site if at least this many reads </span>
<span class="sd">            have called identity.</span>
<span class="sd">        `minconcur` (float)</span>
<span class="sd">            Only call consensus at site if &gt;= this fraction of called</span>
<span class="sd">            identities agree.</span>
<span class="sd">        `use_cutils` (bool)</span>
<span class="sd">            Use the faster implementation in the `_cutils` module.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A string giving the consensus sequence. Non-called </span>
<span class="sd">        sites are returned as ``N```.</span>

<span class="sd">    &gt;&gt;&gt; reads = [&#39;ATGCAT&#39;,</span>
<span class="sd">    ...          &#39;NTGNANA&#39;,</span>
<span class="sd">    ...          &#39;ACGNNTAT&#39;,</span>
<span class="sd">    ...          &#39;NTGNTA&#39;]</span>
<span class="sd">    &gt;&gt;&gt; buildReadConsensus(reads, 2, 0.75) == &#39;ATGNNNAN&#39;</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; reads.append(&#39;CTGCATAT&#39;)</span>
<span class="sd">    &gt;&gt;&gt; buildReadConsensus(reads, 2, 0.75) == &#39;NTGCATAT&#39;</span>
<span class="sd">    True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">use_cutils</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dms_tools2</span><span class="o">.</span><span class="n">_cutils</span><span class="o">.</span><span class="n">buildReadConsensus</span><span class="p">(</span><span class="n">reads</span><span class="p">,</span> 
                <span class="n">minreads</span><span class="p">,</span> <span class="n">minconcur</span><span class="p">)</span>
    <span class="n">readlens</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">reads</span><span class="p">))</span>
    <span class="n">maxlen</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">readlens</span><span class="p">)</span>
    <span class="n">consensus</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">maxlen</span><span class="p">):</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">lenr</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">reads</span><span class="p">,</span> <span class="n">readlens</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">lenr</span> <span class="o">&gt;</span> <span class="n">i</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="s1">&#39;N&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">counts</span><span class="p">:</span>
                        <span class="n">counts</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">counts</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">ntot</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">counts</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">ntot</span> <span class="o">&lt;</span> <span class="n">minreads</span><span class="p">:</span>
            <span class="n">consensus</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;N&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="p">(</span><span class="n">nmax</span><span class="p">,</span> <span class="n">xmax</span><span class="p">)</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([(</span><span class="n">n</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="ow">in</span> <span class="n">counts</span><span class="o">.</span><span class="n">items</span><span class="p">()])[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">nmax</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">ntot</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">minconcur</span><span class="p">:</span>
                <span class="n">consensus</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xmax</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">consensus</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;N&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">consensus</span><span class="p">)</span></div>


<div class="viewcode-block" id="rarefactionCurve"><a class="viewcode-back" href="../../dms_tools2.utils.html#dms_tools2.utils.rarefactionCurve">[docs]</a><span class="k">def</span> <span class="nf">rarefactionCurve</span><span class="p">(</span><span class="n">barcodes</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">maxpoints</span><span class="o">=</span><span class="mf">1e5</span><span class="p">,</span> <span class="n">logspace</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Rarefaction curve from list of barcodes.</span>

<span class="sd">    Uses the analytical formula for the rarefaction curve defined</span>
<span class="sd">    `on Wikipedia &lt;https://en.wikipedia.org/wiki/Rarefaction_(ecology)#Derivation&gt;`_.</span>

<span class="sd">    Args:</span>
<span class="sd">        `barcodes` (list or pandas Series)</span>
<span class="sd">            Holds the list of unique barcodes for which we calculate</span>
<span class="sd">            the rarefaction curve. It is expected that some of these</span>
<span class="sd">            barcodes will be repeated multiple times in the list if</span>
<span class="sd">            the sampling is approaching saturation.</span>
<span class="sd">        `maxpoints` (int)</span>
<span class="sd">            Only calculate values at this many points. The benefit</span>
<span class="sd">            of this is that it can become very costly to calculate</span>
<span class="sd">            the curve at every point when there are many points.</span>
<span class="sd">        `logspace` (True)</span>
<span class="sd">            Logarithmically space the `maxpoints` points for</span>
<span class="sd">            the calculation. This will give better results if</span>
<span class="sd">            we are subsampling and the curve saturates. Only</span>
<span class="sd">            done if we have to subsample.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The 2-tuple `(nreads, nbarcodes)`, where both `nreads` and</span>
<span class="sd">        `nbarcodes` are lists of the same length, and `nbarcodes[i]`</span>
<span class="sd">        is the expected number of barcodes observed when there are</span>
<span class="sd">        `nreads[i]` reads.</span>

<span class="sd">    Here we take a very small list and show that the results given</span>
<span class="sd">    by the function are equivalent to those obtained by random</span>
<span class="sd">    subsampling:</span>

<span class="sd">    &gt;&gt;&gt; barcodes = [&#39;A&#39;, &#39;A&#39;, &#39;A&#39;, &#39;A&#39;, &#39;G&#39;, &#39;G&#39;, &#39;C&#39;, &#39;T&#39;]</span>
<span class="sd">    &gt;&gt;&gt; (nreads, nbarcodes) = rarefactionCurve(barcodes)</span>
<span class="sd">    &gt;&gt;&gt; random.seed(1)</span>
<span class="sd">    &gt;&gt;&gt; nrand = 100000</span>
<span class="sd">    &gt;&gt;&gt; sim_equal_calc = []</span>
<span class="sd">    &gt;&gt;&gt; for n in range(1, len(barcodes) + 1):</span>
<span class="sd">    ...     nbarcodes_sim = sum([len(set(random.sample(barcodes, n)))</span>
<span class="sd">    ...             for _ in range(nrand)]) / nrand</span>
<span class="sd">    ...     sim_equal_calc.append(numpy.allclose(nbarcodes_sim,</span>
<span class="sd">    ...             nbarcodes[nreads.index(n)], atol=1e-2))</span>
<span class="sd">    &gt;&gt;&gt; all(sim_equal_calc)</span>
<span class="sd">    True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">barcodes</span><span class="p">)</span> <span class="c1"># total number of items</span>
    <span class="n">Ni</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">Counter</span><span class="p">(</span><span class="n">barcodes</span><span class="p">)</span>
    <span class="n">K</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Ni</span><span class="p">)</span>
    <span class="n">Mj</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">Counter</span><span class="p">(</span><span class="n">Ni</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="n">Nk</span><span class="p">,</span> <span class="n">num</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">Mj</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>

    <span class="c1"># use simplification that (N - Ni)Cr(n) / (N)Cr(n) =</span>
    <span class="c1"># [(N - Ni)! * (N - n)!] / [N! * (N - Ni - n)!]</span>
    <span class="c1">#</span>
    <span class="c1"># Also use fact that gamma(x + 1) = x!</span>
    <span class="n">nbarcodes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">lnFactorial_N</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">gammaln</span><span class="p">(</span><span class="n">N</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">logspace</span> <span class="ow">and</span> <span class="n">N</span> <span class="o">&gt;</span> <span class="n">maxpoints</span><span class="p">:</span>
        <span class="n">nreads</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span>
                <span class="n">math</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">math</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">N</span><span class="p">),</span>
                <span class="n">num</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">maxpoints</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nreads</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
                <span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">maxpoints</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nreads</span><span class="p">:</span>
        <span class="n">lnFactorial_N_minus_n</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">gammaln</span><span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="n">Nk</span> <span class="o">-</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># indices where this is true</span>
        <span class="n">nbarcodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">K</span> <span class="o">-</span> <span class="p">(</span><span class="n">num</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
                            <span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">gammaln</span><span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="n">Nk</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span>
                            <span class="n">lnFactorial_N_minus_n</span> <span class="o">-</span>
                            <span class="n">lnFactorial_N</span> <span class="o">-</span>
                            <span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">gammaln</span><span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="n">Nk</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">nreads</span><span class="p">,</span> <span class="n">nbarcodes</span><span class="p">)</span></div>


<div class="viewcode-block" id="reverseComplement"><a class="viewcode-back" href="../../dms_tools2.utils.html#dms_tools2.utils.reverseComplement">[docs]</a><span class="k">def</span> <span class="nf">reverseComplement</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">use_cutils</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Gets reverse complement of DNA sequence `s`.</span>

<span class="sd">    Args:</span>
<span class="sd">        `s` (str)</span>
<span class="sd">            Sequence to reverse complement.</span>
<span class="sd">        `use_cutils` (bool)</span>
<span class="sd">            Use the faster implementation in the `_cutils` module.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Reverse complement of `s` as a str.</span>

<span class="sd">    &gt;&gt;&gt; s = &#39;ATGCAAN&#39;</span>
<span class="sd">    &gt;&gt;&gt; reverseComplement(s) == &#39;NTTGCAT&#39;</span>
<span class="sd">    True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">use_cutils</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dms_tools2</span><span class="o">.</span><span class="n">_cutils</span><span class="o">.</span><span class="n">reverseComplement</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">reversed</span><span class="p">([</span><span class="n">dms_tools2</span><span class="o">.</span><span class="n">NTCOMPLEMENT</span><span class="p">[</span><span class="n">nt</span><span class="p">]</span> <span class="k">for</span> <span class="n">nt</span> <span class="ow">in</span> <span class="n">s</span><span class="p">]))</span></div>


<div class="viewcode-block" id="alignSubamplicon"><a class="viewcode-back" href="../../dms_tools2.utils.html#dms_tools2.utils.alignSubamplicon">[docs]</a><span class="k">def</span> <span class="nf">alignSubamplicon</span><span class="p">(</span><span class="n">refseq</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">refseqstart</span><span class="p">,</span> <span class="n">refseqend</span><span class="p">,</span> <span class="n">maxmuts</span><span class="p">,</span>
        <span class="n">maxN</span><span class="p">,</span> <span class="n">chartype</span><span class="p">,</span> <span class="n">use_cutils</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Try to align subamplicon to reference sequence at defined location.</span>

<span class="sd">    Tries to align reads `r1` and `r2` to `refseq` at location</span>
<span class="sd">    specified by `refseqstart` and `refseqend`. Determines how many</span>
<span class="sd">    sites of type `chartype` have mutations, and if &lt;= `maxmuts` conside</span>
<span class="sd">    the subamplicon to align if fraction of ambiguous nucleotides &lt;= `maxN`.</span>
<span class="sd">    In `r1` and `r2`, an ``N`` indicates a non-called ambiguous identity.</span>
<span class="sd">    If the reads disagree in a region of overlap that is set to ``N`` in</span>
<span class="sd">    the final subamplicon, but if one read has ``N`` and the other a called</span>
<span class="sd">    identity, then the called identity is used in the final subamplicon.</span>

<span class="sd">    Args:</span>
<span class="sd">        `refseq` (str)</span>
<span class="sd">            Sequence to which we align. if `chartype` is &#39;codon&#39;,</span>
<span class="sd">            must be a valid coding (length multiple of 3).</span>
<span class="sd">        `r1` (str)</span>
<span class="sd">            The forward sequence to align.</span>
<span class="sd">        `r2` (str)</span>
<span class="sd">            The reverse sequence to align. When reverse complemented,</span>
<span class="sd">            should read backwards in `refseq`.</span>
<span class="sd">        `refseqstart` (int)</span>
<span class="sd">            The nucleotide in `refseq` (1, 2, ... numbering) where the</span>
<span class="sd">            first nucleotide in `r1` aligns.</span>
<span class="sd">        `refseqend` (int)</span>
<span class="sd">            The nucleotide in `refseq` (1, 2, ... numbering) where the</span>
<span class="sd">            first nucleotide in `r2` aligns (note that `r2` then reads</span>
<span class="sd">            backwards towards the 5&#39; end of `refseq`).</span>
<span class="sd">        `maxmuts` (int or float)</span>
<span class="sd">            Maximum number of mutations of character `chartype` that</span>
<span class="sd">            are allowed in the aligned subamplicons from the two reads.</span>
<span class="sd">        `maxN` (int or float)</span>
<span class="sd">            Maximum number of nucleotides for which we allow</span>
<span class="sd">            ambiguous (``N``) identities in final subamplicon.</span>
<span class="sd">        `chartype` (str)</span>
<span class="sd">            Character type for which we count mutations.</span>
<span class="sd">            Currently, the only allowable value is &#39;codon&#39;.</span>
<span class="sd">        `use_cutils` (bool)</span>
<span class="sd">            Use the faster implementation in the `_cutils` module.</span>

<span class="sd">    Returns:</span>
<span class="sd">        If reads align, return aligned subamplicon as string (of length</span>
<span class="sd">        `refseqend - refseqstart + 1`). Otherwise return `None`.</span>

<span class="sd">    &gt;&gt;&gt; refseq = &#39;ATGGGGAAA&#39;</span>
<span class="sd">    &gt;&gt;&gt; s = alignSubamplicon(refseq, &#39;GGGGAA&#39;, &#39;TTTCCC&#39;, 3, 9, 1, 1, &#39;codon&#39;)</span>
<span class="sd">    &gt;&gt;&gt; s == &#39;GGGGAAA&#39; </span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; s = alignSubamplicon(refseq, &#39;GGGGAA&#39;, &#39;TTTCCC&#39;, 1, 9, 1, 1, &#39;codon&#39;)</span>
<span class="sd">    &gt;&gt;&gt; s == False</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; s = alignSubamplicon(refseq, &#39;GGGGAT&#39;, &#39;TTTCCC&#39;, 3, 9, 1, 0, &#39;codon&#39;)</span>
<span class="sd">    &gt;&gt;&gt; s == False</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; s = alignSubamplicon(refseq, &#39;GGGGAT&#39;, &#39;TTTCCC&#39;, 3, 9, 1, 1, &#39;codon&#39;)</span>
<span class="sd">    &gt;&gt;&gt; s == &#39;GGGGANA&#39;</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; s = alignSubamplicon(refseq, &#39;GGGGAT&#39;, &#39;TATCCC&#39;, 3, 9, 1, 0, &#39;codon&#39;)</span>
<span class="sd">    &gt;&gt;&gt; s == &#39;GGGGATA&#39;</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; s = alignSubamplicon(refseq, &#39;GGGGAT&#39;, &#39;TATCCC&#39;, 3, 9, 0, 0, &#39;codon&#39;)</span>
<span class="sd">    &gt;&gt;&gt; s == False</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; s = alignSubamplicon(refseq, &#39;GGGNAA&#39;, &#39;TTTCCC&#39;, 3, 9, 0, 0, &#39;codon&#39;)</span>
<span class="sd">    &gt;&gt;&gt; s == &#39;GGGGAAA&#39;</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; s = alignSubamplicon(refseq, &#39;GGGNAA&#39;, &#39;TTNCCC&#39;, 3, 9, 0, 0, &#39;codon&#39;)</span>
<span class="sd">    &gt;&gt;&gt; s == &#39;GGGGAAA&#39;</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; s = alignSubamplicon(refseq, &#39;GTTTAA&#39;, &#39;TTTAAA&#39;, 3, 9, 1, 0, &#39;codon&#39;)</span>
<span class="sd">    &gt;&gt;&gt; s == &#39;GTTTAAA&#39; </span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; s = alignSubamplicon(refseq, &#39;GGGGTA&#39;, &#39;TTACCC&#39;, 3, 9, 1, 0, &#39;codon&#39;)</span>
<span class="sd">    &gt;&gt;&gt; s == &#39;GGGGTAA&#39; </span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; s = alignSubamplicon(refseq, &#39;GGGCTA&#39;, &#39;TTAGCC&#39;, 3, 9, 1, 0, &#39;codon&#39;)</span>
<span class="sd">    &gt;&gt;&gt; s == False </span>
<span class="sd">    True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">r2</span> <span class="o">=</span> <span class="n">reverseComplement</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">use_cutils</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dms_tools2</span><span class="o">.</span><span class="n">_cutils</span><span class="o">.</span><span class="n">alignSubamplicon</span><span class="p">(</span><span class="n">refseq</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> 
                <span class="n">refseqstart</span><span class="p">,</span> <span class="n">refseqend</span><span class="p">,</span> <span class="n">maxmuts</span><span class="p">,</span> <span class="n">maxN</span><span class="p">,</span> <span class="n">chartype</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">chartype</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;codon&#39;</span><span class="p">],</span> <span class="s2">&quot;Invalid chartype&quot;</span>
    <span class="k">if</span> <span class="n">chartype</span> <span class="o">==</span> <span class="s1">&#39;codon&#39;</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">refseq</span><span class="p">)</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;refseq length not divisible by 3&quot;</span>

    <span class="n">len_subamplicon</span> <span class="o">=</span> <span class="n">refseqend</span> <span class="o">-</span> <span class="n">refseqstart</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">len_r1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">r1</span><span class="p">)</span>
    <span class="n">len_subamplicon_minus_len_r2</span> <span class="o">=</span> <span class="n">len_subamplicon</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>
    <span class="n">subamplicon</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">len_subamplicon</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len_subamplicon_minus_len_r2</span><span class="p">:</span> <span class="c1"># site not in r2</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len_r1</span><span class="p">:</span> <span class="c1"># site in r1</span>
                <span class="n">subamplicon</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r1</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># site not in r1</span>
                <span class="n">subamplicon</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;N&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># site in r2</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len_r1</span><span class="p">:</span> <span class="c1"># site in r1</span>
                <span class="n">r1i</span> <span class="o">=</span> <span class="n">r1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">r2i</span> <span class="o">=</span> <span class="n">r2</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">len_subamplicon_minus_len_r2</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">r1i</span> <span class="o">==</span> <span class="n">r2i</span><span class="p">:</span>
                    <span class="n">subamplicon</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r1i</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">r1i</span> <span class="o">==</span> <span class="s1">&#39;N&#39;</span><span class="p">:</span>
                    <span class="n">subamplicon</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r2i</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">r2i</span> <span class="o">==</span> <span class="s1">&#39;N&#39;</span><span class="p">:</span>
                    <span class="n">subamplicon</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r1i</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">subamplicon</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;N&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># site not in r1</span>
                <span class="n">subamplicon</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r2</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">len_subamplicon_minus_len_r2</span><span class="p">])</span>
    <span class="n">subamplicon</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subamplicon</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">subamplicon</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;N&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">maxN</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">chartype</span> <span class="o">==</span> <span class="s1">&#39;codon&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">refseqstart</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">startcodon</span> <span class="o">=</span> <span class="p">(</span><span class="n">refseqstart</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">//</span> <span class="mi">3</span>
            <span class="n">codonshift</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">refseqstart</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">startcodon</span> <span class="o">=</span> <span class="p">(</span><span class="n">refseqstart</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">codonshift</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">elif</span> <span class="n">refseqstart</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">startcodon</span> <span class="o">=</span> <span class="n">refseqstart</span> <span class="o">//</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">codonshift</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">nmuts</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">icodon</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">startcodon</span><span class="p">,</span> <span class="n">refseqend</span> <span class="o">//</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">mutcodon</span> <span class="o">=</span> <span class="n">subamplicon</span><span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="n">icodon</span> <span class="o">-</span> <span class="n">startcodon</span><span class="p">)</span> <span class="o">+</span> <span class="n">codonshift</span> <span class="p">:</span> 
                    <span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="n">icodon</span> <span class="o">-</span> <span class="n">startcodon</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">codonshift</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;N&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mutcodon</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">mutcodon</span> <span class="o">!=</span> 
                    <span class="n">refseq</span><span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="n">icodon</span> <span class="o">-</span> <span class="mi">3</span> <span class="p">:</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">icodon</span><span class="p">]):</span>
                <span class="n">nmuts</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">nmuts</span> <span class="o">&gt;</span> <span class="n">maxmuts</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid chartype&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">subamplicon</span></div>


<div class="viewcode-block" id="incrementCounts"><a class="viewcode-back" href="../../dms_tools2.utils.html#dms_tools2.utils.incrementCounts">[docs]</a><span class="k">def</span> <span class="nf">incrementCounts</span><span class="p">(</span><span class="n">refseqstart</span><span class="p">,</span> <span class="n">subamplicon</span><span class="p">,</span> <span class="n">chartype</span><span class="p">,</span> <span class="n">counts</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Increment counts dict based on an aligned subamplicon.</span>

<span class="sd">    This is designed for keeping track of counts of different</span>
<span class="sd">    mutations / identities when aligning many subamplicons to</span>
<span class="sd">    a sequence.</span>

<span class="sd">    Any positions where `subamplicon` has an ``N`` are ignored,</span>
<span class="sd">    and not added to `counts`.</span>

<span class="sd">    Args:</span>
<span class="sd">        `refseqstart` (int)</span>
<span class="sd">            First nucleotide position in 1, 2, ... numbering </span>
<span class="sd">            where `subamplicon` aligns.</span>
<span class="sd">        `subamplicon` (str)</span>
<span class="sd">            The subamplicon.</span>
<span class="sd">        `chartype` (str)</span>
<span class="sd">            Character type for which we are counting mutations.</span>
<span class="sd">            Currently, only allowable value is &#39;codon&#39;.</span>
<span class="sd">        `counts` (dict)</span>
<span class="sd">            Stores counts of identities, and is incremented by</span>
<span class="sd">            this function. Is a dict keyed by every possible</span>
<span class="sd">            character (e.g., codon), with values lists with</span>
<span class="sd">            element `i` holding the counts for position `i`</span>
<span class="sd">            in 0, 1, ... numbering.</span>

<span class="sd">    Returns:</span>
<span class="sd">        On completion, `counts` has been incremented.</span>

<span class="sd">    &gt;&gt;&gt; codonlen = 10</span>
<span class="sd">    &gt;&gt;&gt; counts = dict([(codon, [0] * codonlen) for codon </span>
<span class="sd">    ...         in CODONS])</span>
<span class="sd">    &gt;&gt;&gt; subamplicon1 = &#39;ATGGACTTTC&#39;</span>
<span class="sd">    &gt;&gt;&gt; incrementCounts(1, subamplicon1, &#39;codon&#39;, counts)</span>
<span class="sd">    &gt;&gt;&gt; subamplicon2 = &#39;GGTCTTTCCCGGN&#39;</span>
<span class="sd">    &gt;&gt;&gt; incrementCounts(3, subamplicon2, &#39;codon&#39;, counts)</span>
<span class="sd">    &gt;&gt;&gt; counts[&#39;ATG&#39;][0] == 1</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; counts[&#39;GAC&#39;][1] == 1</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; counts[&#39;GTC&#39;][1] == 1</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; counts[&#39;TTT&#39;][2] == 2</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; counts[&#39;CCC&#39;][3] == 1</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; sum([sum(c) for c in counts.values()]) == 6</span>
<span class="sd">    True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">chartype</span> <span class="o">==</span> <span class="s1">&#39;codon&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">refseqstart</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">startcodon</span> <span class="o">=</span> <span class="p">(</span><span class="n">refseqstart</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">//</span> <span class="mi">3</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">codonshift</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">refseqstart</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">startcodon</span> <span class="o">=</span> <span class="p">(</span><span class="n">refseqstart</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">3</span> 
            <span class="n">codonshift</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">elif</span> <span class="n">refseqstart</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">startcodon</span> <span class="o">=</span> <span class="n">refseqstart</span> <span class="o">//</span> <span class="mi">3</span> 
            <span class="n">codonshift</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid chartype&quot;</span><span class="p">)</span>

    <span class="n">shiftedsubamplicon</span> <span class="o">=</span> <span class="n">subamplicon</span><span class="p">[</span><span class="n">codonshift</span> <span class="p">:</span> <span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">shiftedsubamplicon</span><span class="p">)</span> <span class="o">//</span> <span class="mi">3</span><span class="p">):</span>
        <span class="n">codon</span> <span class="o">=</span> <span class="n">shiftedsubamplicon</span><span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="n">i</span> <span class="p">:</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;N&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">codon</span><span class="p">:</span>
            <span class="n">counts</span><span class="p">[</span><span class="n">codon</span><span class="p">][</span><span class="n">startcodon</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="codonToAACounts"><a class="viewcode-back" href="../../dms_tools2.utils.html#dms_tools2.utils.codonToAACounts">[docs]</a><span class="k">def</span> <span class="nf">codonToAACounts</span><span class="p">(</span><span class="n">counts</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Makes amino-acid counts `pandas.DataFrame` from codon counts.</span>

<span class="sd">    Args:</span>
<span class="sd">        `counts` (`pandas.DataFrame`)</span>
<span class="sd">            Columns are the string `site` `wildtype` and all codons</span>
<span class="sd">            in `CODONS`. Additional columns are allowed</span>
<span class="sd">            but ignored.</span>

<span class="sd">    Returns:</span>
<span class="sd">        `aacounts` (`pandas.DataFrame`)</span>
<span class="sd">            Columns are the string `site` and all amino acids</span>
<span class="sd">            in `AAS_WITHSTOP` with counts for each</span>
<span class="sd">            amino acid made by summing counts for encoding codons.</span>

<span class="sd">    &gt;&gt;&gt; d = {&#39;site&#39;:[1, 2], &#39;othercol&#39;:[0, 0], &#39;ATG&#39;:[105, 1],</span>
<span class="sd">    ...         &#39;GGG&#39;:[3, 117], &#39;GGA&#39;:[2, 20], &#39;TGA&#39;:[0, 1],</span>
<span class="sd">    ...         &#39;wildtype&#39;:[&#39;ATG&#39;, &#39;GGG&#39;]}</span>
<span class="sd">    &gt;&gt;&gt; for codon in CODONS:</span>
<span class="sd">    ...     if codon not in d:</span>
<span class="sd">    ...         d[codon] = [0, 0]</span>
<span class="sd">    &gt;&gt;&gt; counts = pandas.DataFrame(d)</span>
<span class="sd">    &gt;&gt;&gt; aacounts = codonToAACounts(counts)</span>
<span class="sd">    &gt;&gt;&gt; &#39;othercol&#39; in aacounts.columns</span>
<span class="sd">    False</span>
<span class="sd">    &gt;&gt;&gt; all(aacounts[&#39;site&#39;] == [1, 2])</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; all(aacounts[&#39;wildtype&#39;] == [&#39;M&#39;, &#39;G&#39;])</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; all(aacounts[&#39;M&#39;] == [105, 1])</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; all(aacounts[&#39;G&#39;] == [5, 137])</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; all(aacounts[&#39;*&#39;] == [0, 1])</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; all(aacounts[&#39;V&#39;] == [0, 0])</span>
<span class="sd">    True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">key</span><span class="p">,</span> <span class="p">[])</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">,</span> <span class="s1">&#39;wildtype&#39;</span><span class="p">]</span> <span class="o">+</span> 
            <span class="n">AAS_WITHSTOP</span><span class="p">])</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span> <span class="ow">in</span> <span class="n">counts</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">])</span>
        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;wildtype&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CODON_TO_AA</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;wildtype&#39;</span><span class="p">]])</span>
        <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">AAS_WITHSTOP</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="n">aa</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">CODONS</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="n">CODON_TO_AA</span><span class="p">[</span><span class="n">c</span><span class="p">]][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">d</span><span class="p">)</span></div>


<div class="viewcode-block" id="annotateCodonCounts"><a class="viewcode-back" href="../../dms_tools2.utils.html#dms_tools2.utils.annotateCodonCounts">[docs]</a><span class="k">def</span> <span class="nf">annotateCodonCounts</span><span class="p">(</span><span class="n">counts</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Gets annotated `pandas.DataFrame` from codon counts.</span>

<span class="sd">    Some of the programs (e.g., `dms2_bcsubamplicons`) create </span>
<span class="sd">    ``*_codoncounts.csv`` files when run with ``--chartype codon``.</span>
<span class="sd">    These CSV files have columns indicating the `site` and `wildtype`</span>
<span class="sd">    codon, as well as a column for each codon giving the counts for that </span>
<span class="sd">    codon. This function reads that file (or a `pandas.DataFrame` read</span>
<span class="sd">    from it) to return a `pandas.DataFrame` where a variety of additional</span>
<span class="sd">    useful annotations have been added.</span>

<span class="sd">    Args:</span>
<span class="sd">        `counts` (str)</span>
<span class="sd">            Name of existing codon counts CSV file, or `pandas.DataFrame`</span>
<span class="sd">            holding counts.</span>

<span class="sd">    Returns:</span>
<span class="sd">        `df` (`pandas.DataFrame`)</span>
<span class="sd">            The DataFrame with the information in `counts` plus</span>
<span class="sd">            the following added columns for each site:</span>

<span class="sd">                `ncounts` : number of counts at site</span>

<span class="sd">                `mutfreq` : mutation frequency at site</span>

<span class="sd">                `nstop` : number of stop-codon mutations</span>

<span class="sd">                `nsyn` : number of synonymous mutations</span>

<span class="sd">                `nnonsyn` : number of nonsynonymous mutations</span>

<span class="sd">                `n1nt` : number of 1-nucleotide codon mutations</span>

<span class="sd">                `n2nt` : number of 2-nucleotide codon mutations</span>

<span class="sd">                `n3nt` : number of 3-nucleotide codon mutations</span>

<span class="sd">                `AtoC`, `AtoG`, etc : number of each nucleotide mutation</span>
<span class="sd">                type among codon mutations with **one** nucleotide change.</span>

<span class="sd">                `mutfreq1nt`, `mutfreq2nt`, `mutfreq3nt` : frequency</span>
<span class="sd">                of 1-, 2-, and 3-nucleotide codon mutations at site.</span>

<span class="sd">    &gt;&gt;&gt; d = {&#39;site&#39;:[1, 2], &#39;wildtype&#39;:[&#39;ATG&#39;, &#39;GGG&#39;], &#39;ATG&#39;:[105, 1],</span>
<span class="sd">    ...         &#39;GGG&#39;:[3, 117], &#39;GGA&#39;:[2, 20], &#39;TGA&#39;:[0, 1]}</span>
<span class="sd">    &gt;&gt;&gt; for codon in CODONS:</span>
<span class="sd">    ...     if codon not in d:</span>
<span class="sd">    ...         d[codon] = [0, 0]</span>
<span class="sd">    &gt;&gt;&gt; counts = pandas.DataFrame(d)</span>
<span class="sd">    &gt;&gt;&gt; with tempfile.NamedTemporaryFile(mode=&#39;w&#39;) as f:</span>
<span class="sd">    ...     counts.to_csv(f, index=False)</span>
<span class="sd">    ...     f.flush()</span>
<span class="sd">    ...     df = annotateCodonCounts(f.name)</span>
<span class="sd">    &gt;&gt;&gt; all([all(df[col] == counts[col]) for col in counts.columns])</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; all(df[&#39;ncounts&#39;] == [110, 139])</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; all(df[&#39;mutfreq&#39;] == [5 / 110., 22 / 139.])</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; all(df[&#39;nstop&#39;] == [0, 1])</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; all(df[&#39;nsyn&#39;] == [0, 20])</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; all(df[&#39;nnonsyn&#39;] == [5, 1])</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; all(df[&#39;n1nt&#39;] == [0, 20])</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; all(df[&#39;n2nt&#39;] == [3, 2])</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; all(df[&#39;n3nt&#39;] == [2, 0])</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; all(df[&#39;GtoA&#39;] == [0, 20])</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; all(df[&#39;AtoC&#39;] == [0, 0])</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; all(df[&#39;mutfreq1nt&#39;] == [0, 20 / 139.])</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; all(df[&#39;mutfreq3nt&#39;] == [2 / 110., 0])</span>
<span class="sd">    True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">counts</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;invalid counts&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">CODONS</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">),</span> \
            <span class="s2">&quot;Did not find counts for all codons&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">counts</span><span class="p">)</span>

    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ncounts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">CODONS</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;mutfreq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;ncounts&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;wildtype&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;wildtype&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">))</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ncounts&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">))</span>
            <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

    <span class="n">ntchanges</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">to</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nt1</span><span class="p">,</span> <span class="n">nt2</span><span class="p">)</span> <span class="k">for</span> <span class="n">nt1</span> <span class="ow">in</span> <span class="n">dms_tools2</span><span class="o">.</span><span class="n">NTS</span>
            <span class="k">for</span> <span class="n">nt2</span> <span class="ow">in</span> <span class="n">dms_tools2</span><span class="o">.</span><span class="n">NTS</span> <span class="k">if</span> <span class="n">nt1</span> <span class="o">!=</span> <span class="n">nt2</span><span class="p">]</span>

    <span class="n">nstoplist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">nsynlist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">nnonsynlist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">nXntlists</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">[])</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
    <span class="n">nntchangeslists</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">ntchange</span><span class="p">,</span> <span class="p">[])</span> <span class="k">for</span> <span class="n">ntchange</span> <span class="ow">in</span> <span class="n">ntchanges</span><span class="p">])</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">nstop</span> <span class="o">=</span> <span class="n">nsyn</span> <span class="o">=</span> <span class="n">nnonsyn</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">nXnt</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
        <span class="n">nntchanges</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">ntchange</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">ntchange</span> <span class="ow">in</span> <span class="n">ntchanges</span><span class="p">])</span>
        <span class="n">wt</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;wildtype&#39;</span><span class="p">]</span>
        <span class="n">wtaa</span> <span class="o">=</span> <span class="n">CODON_TO_AA</span><span class="p">[</span><span class="n">wt</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">CODONS</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="n">wt</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">aa</span> <span class="o">=</span> <span class="n">CODON_TO_AA</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">aa</span> <span class="o">==</span> <span class="s1">&#39;*&#39;</span><span class="p">:</span>
                <span class="n">nstop</span> <span class="o">+=</span> <span class="n">row</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">aa</span> <span class="o">==</span> <span class="n">wtaa</span><span class="p">:</span>
                <span class="n">nsyn</span> <span class="o">+=</span> <span class="n">row</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nnonsyn</span> <span class="o">+=</span> <span class="n">row</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
            <span class="n">ntdiffs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">to</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nt1</span><span class="p">,</span> <span class="n">nt2</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">nt1</span><span class="p">,</span> <span class="n">nt2</span><span class="p">)</span> 
                    <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">wt</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="k">if</span> <span class="n">nt1</span> <span class="o">!=</span> <span class="n">nt2</span><span class="p">]</span>
            <span class="n">nXnt</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">ntdiffs</span><span class="p">)]</span> <span class="o">+=</span> <span class="n">row</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ntdiffs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">nntchanges</span><span class="p">[</span><span class="n">ntdiffs</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">row</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
        <span class="n">nstoplist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nstop</span><span class="p">)</span>
        <span class="n">nsynlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nsyn</span><span class="p">)</span>
        <span class="n">nnonsynlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nnonsyn</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">nXntlists</span><span class="p">[</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nXnt</span><span class="p">[</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">ntchange</span> <span class="ow">in</span> <span class="n">ntchanges</span><span class="p">:</span>
            <span class="n">nntchangeslists</span><span class="p">[</span><span class="n">ntchange</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nntchanges</span><span class="p">[</span><span class="n">ntchange</span><span class="p">])</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">nstop</span><span class="o">=</span><span class="n">nstoplist</span><span class="p">,</span> <span class="n">nsyn</span><span class="o">=</span><span class="n">nsynlist</span><span class="p">,</span> <span class="n">nnonsyn</span><span class="o">=</span><span class="n">nnonsynlist</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">n1nt</span><span class="o">=</span><span class="n">nXntlists</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">n2nt</span><span class="o">=</span><span class="n">nXntlists</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">n3nt</span><span class="o">=</span><span class="n">nXntlists</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">ntchange</span> <span class="ow">in</span> <span class="n">ntchanges</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="n">ntchange</span><span class="p">]</span> <span class="o">=</span> <span class="n">nntchangeslists</span><span class="p">[</span><span class="n">ntchange</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">nnt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;mutfreq</span><span class="si">{0}</span><span class="s1">nt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;n</span><span class="si">{0}</span><span class="s1">nt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
            <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ncounts&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="adjustErrorCounts"><a class="viewcode-back" href="../../dms_tools2.utils.html#dms_tools2.utils.adjustErrorCounts">[docs]</a><span class="k">def</span> <span class="nf">adjustErrorCounts</span><span class="p">(</span><span class="n">errcounts</span><span class="p">,</span> <span class="n">counts</span><span class="p">,</span> <span class="n">charlist</span><span class="p">,</span> <span class="n">maxexcess</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Adjust error counts to not greatly exceed counts of interest.</span>

<span class="sd">    This function is useful when estimating preferences. Under the</span>
<span class="sd">    model, the error-control should not have a higher rate of error</span>
<span class="sd">    than the actual sample. However, this could happen if the experimental</span>
<span class="sd">    data don&#39;t fully meet the assumptions. So this function scales</span>
<span class="sd">    down the error counts in that case.</span>

<span class="sd">    Args:</span>
<span class="sd">        `errcounts` (pandas.DataFrame)</span>
<span class="sd">            Holds counts for error control.</span>
<span class="sd">        `counts` (pandas.DataFrame)</span>
<span class="sd">            Holds counts for which we are correcting errors.</span>
<span class="sd">        `charlist` (list)</span>
<span class="sd">            Characters for which we have counts.</span>
<span class="sd">        `maxexcess` (int)</span>
<span class="sd">            Only let error-control counts exceed actual by this much.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A copy of `errcounts` except for any non-wildtype character,</span>
<span class="sd">        the maximum frequency of that character is adjusted to be</span>
<span class="sd">        at most the number predicted by the frequency in `counts`</span>
<span class="sd">        plus `maxexcess`.</span>

<span class="sd">    &gt;&gt;&gt; counts = pandas.DataFrame({&#39;site&#39;:[1], &#39;wildtype&#39;:[&#39;A&#39;], </span>
<span class="sd">    ...         &#39;A&#39;:500, &#39;C&#39;:10, &#39;G&#39;:40, &#39;T&#39;:20})</span>
<span class="sd">    &gt;&gt;&gt; errcounts = pandas.DataFrame({&#39;site&#39;:[1], &#39;wildtype&#39;:[&#39;A&#39;],</span>
<span class="sd">    ...         &#39;A&#39;:250, &#39;C&#39;:1, &#39;G&#39;:30, &#39;T&#39;:10})</span>
<span class="sd">    &gt;&gt;&gt; charlist = [&#39;A&#39;, &#39;C&#39;, &#39;G&#39;, &#39;T&#39;]</span>
<span class="sd">    &gt;&gt;&gt; errcounts = errcounts[[&#39;site&#39;, &#39;wildtype&#39;] + charlist]</span>
<span class="sd">    &gt;&gt;&gt; adj_errcounts = adjustErrorCounts(errcounts, counts, charlist, 1)</span>
<span class="sd">    &gt;&gt;&gt; set(adj_errcounts.columns) == set(errcounts.columns)</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; all(adj_errcounts[&#39;site&#39;] == errcounts[&#39;site&#39;])</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; all(adj_errcounts[&#39;wildtype&#39;] == errcounts[&#39;wildtype&#39;])</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; (adj_errcounts[adj_errcounts[&#39;site&#39;] == 1][charlist].values[0]</span>
<span class="sd">    ...         == numpy.array([250, 1, 21, 10])).all()</span>
<span class="sd">    True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">columns</span>
    <span class="n">counts</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;site&#39;</span><span class="p">)</span>
    <span class="n">errcounts</span> <span class="o">=</span> <span class="n">errcounts</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;site&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">counts</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">errcounts</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">])</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">counts</span><span class="p">[</span><span class="s1">&#39;wildtype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">errcounts</span><span class="p">[</span><span class="s1">&#39;wildtype&#39;</span><span class="p">])</span>
    <span class="n">counts</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">counts</span><span class="p">[</span><span class="n">charlist</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">)</span>
    <span class="n">errcounts</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">errcounts</span><span class="p">[</span><span class="n">charlist</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">maxallowed</span> <span class="o">=</span> <span class="p">(</span><span class="n">counts</span><span class="p">[</span><span class="n">charlist</span><span class="p">]</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">counts</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span>
            <span class="n">errcounts</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">maxexcess</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
    <span class="n">adj_errcounts</span> <span class="o">=</span> <span class="n">errcounts</span><span class="p">[</span><span class="n">charlist</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">errcounts</span><span class="p">[</span><span class="n">charlist</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">maxallowed</span><span class="p">,</span> 
            <span class="n">maxallowed</span><span class="p">[</span><span class="n">charlist</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">charlist</span><span class="p">:</span>
        <span class="n">adj_errcounts</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">adj_errcounts</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">counts</span><span class="p">[</span><span class="s1">&#39;wildtype&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">c</span><span class="p">,</span>
                <span class="n">errcounts</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">charlist</span><span class="p">:</span>
            <span class="n">adj_errcounts</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">counts</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">adj_errcounts</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span></div>


<div class="viewcode-block" id="convertCountsFormat"><a class="viewcode-back" href="../../dms_tools2.utils.html#dms_tools2.utils.convertCountsFormat">[docs]</a><span class="k">def</span> <span class="nf">convertCountsFormat</span><span class="p">(</span><span class="n">oldfile</span><span class="p">,</span> <span class="n">newfile</span><span class="p">,</span> <span class="n">charlist</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert counts file from ``dms_tools`` to ``dms_tools2`` format.</span>

<span class="sd">    Args:</span>
<span class="sd">        `oldfile` (str)</span>
<span class="sd">            Name of counts file in the old ``dms_tools`` format:</span>
<span class="sd">            http://jbloomlab.github.io/dms_tools/fileformats.html</span>
<span class="sd">        `newfile` (str)</span>
<span class="sd">            Name of created counts file in the ``dms_tools2`` format:</span>
<span class="sd">            https://jbloomlab.github.io/dms_tools2/dms2_bcsubamp.html</span>
<span class="sd">        `charlist` (list)</span>
<span class="sd">            List of characters that we expect in the counts files.</span>
<span class="sd">            For instance, could be `CODONS`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">oldfile</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">header</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;#&#39;</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;POSITION&#39;</span> <span class="ow">and</span> <span class="n">cols</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;WT&#39;</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">,</span> <span class="s1">&#39;wildtype&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">cols</span><span class="p">[</span><span class="mi">2</span> <span class="p">:</span> <span class="p">]</span>
    <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">charlist</span><span class="p">)</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="n">cols</span><span class="p">[</span><span class="mi">2</span> <span class="p">:</span> <span class="p">])</span>
    <span class="n">old</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">oldfile</span><span class="p">,</span> <span class="n">delim_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
            <span class="n">names</span><span class="o">=</span><span class="n">cols</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;#&#39;</span><span class="p">)</span>
    <span class="n">old</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">newfile</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="renumberSites"><a class="viewcode-back" href="../../dms_tools2.utils.html#dms_tools2.utils.renumberSites">[docs]</a><span class="k">def</span> <span class="nf">renumberSites</span><span class="p">(</span><span class="n">renumbfile</span><span class="p">,</span> <span class="n">infiles</span><span class="p">,</span> <span class="n">missing</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">,</span>
        <span class="n">outfiles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">outprefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">outdir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Renumber sites in CSV files.</span>

<span class="sd">    Switch numbering scheme in files with a column named `site`. </span>

<span class="sd">    You must specify **exactly one** of `outfiles`,</span>
<span class="sd">    `outprefix`, and `outdir` as something other than `None`.</span>

<span class="sd">    Args:</span>
<span class="sd">        `renumbfile` (str)</span>
<span class="sd">            Name of existing CSV file with the re-numbering scheme.</span>
<span class="sd">            Should have columns with name `original` and `new`.</span>
<span class="sd">            Each entry in `original` should refer to a site in </span>
<span class="sd">            the input files, and each entry in `new` should be</span>
<span class="sd">            the new number for this site. If an entry in `new`</span>
<span class="sd">            is `None` or `nan` then it is dropped from the newly</span>
<span class="sd">            numbered files regardless of `missing`.</span>
<span class="sd">        `infiles` (list)</span>
<span class="sd">            List of existing CSV files that we are re-numbering.</span>
<span class="sd">            Each file must have an entry of `site`.</span>
<span class="sd">        `missing` (str)</span>
<span class="sd">            How to handle sites in `infiles` but not `renumbfile`.</span>
<span class="sd">                - `error`: raise an error</span>
<span class="sd">                - `skip`: skip renumbering, leave with original number </span>
<span class="sd">                - `drop`: drop any sites not in `renumbfile`</span>
<span class="sd">        `outfiles` (list)</span>
<span class="sd">            List of output files of the same length as `infiles`.</span>
<span class="sd">            The numbered version of `infiles` is named as the</span>
<span class="sd">            corresponding entry in `outfiles`.</span>
<span class="sd">        `outdir` (str)</span>
<span class="sd">            A directory name. The renumbered files have the same</span>
<span class="sd">            names as in `infile`, but are now placed in `outdir`.</span>
<span class="sd">        `outprefix` (str)</span>
<span class="sd">            The renumbered files have the same names and locations</span>
<span class="sd">            as `infiles`, but have the pre-pended filename extension</span>
<span class="sd">            `outprefix`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">renumbfile</span><span class="p">),</span> <span class="s2">&quot;no renumbfile </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">renumbfile</span><span class="p">)</span>
    <span class="n">renumb</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">renumbfile</span><span class="p">)</span>
    <span class="k">assert</span> <span class="p">{</span><span class="s1">&#39;original&#39;</span><span class="p">,</span> <span class="s1">&#39;new&#39;</span><span class="p">}</span> <span class="o">&lt;=</span>  <span class="nb">set</span><span class="p">(</span><span class="n">renumb</span><span class="o">.</span><span class="n">columns</span><span class="p">),</span> \
            <span class="s2">&quot;renumbfile lacks columns `original` and/or `new`&quot;</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;original&#39;</span><span class="p">,</span> <span class="s1">&#39;new&#39;</span><span class="p">]:</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">renumb</span><span class="p">[</span><span class="n">col</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">renumb</span><span class="p">[</span><span class="n">col</span><span class="p">])),</span> \
                <span class="s2">&quot;duplicate sites for </span><span class="si">{0}</span><span class="s2"> in </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">renumbfile</span><span class="p">)</span>
        <span class="n">renumb</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">renumb</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">infiles</span><span class="p">,</span> <span class="nb">list</span><span class="p">),</span> <span class="s2">&quot;infiles is not a list&quot;</span>
    <span class="n">nin</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">infiles</span><span class="p">)</span>
    <span class="n">infiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">infiles</span><span class="p">]</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">infiles</span><span class="p">))</span> <span class="o">==</span> <span class="n">nin</span><span class="p">,</span> <span class="s2">&quot;duplicate files in `infiles`&quot;</span>

    <span class="k">if</span> <span class="n">outfiles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">outfiles</span><span class="p">,</span> <span class="nb">list</span><span class="p">),</span> <span class="s2">&quot;`outfiles` not list&quot;</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">outdir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">outprefix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">),</span> \
                <span class="s2">&quot;only specify one of `outfiles`, `outdir`, and `outprefix`&quot;</span>
        <span class="n">nout</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">outfiles</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">nout</span> <span class="o">==</span> <span class="n">nin</span><span class="p">,</span> <span class="s2">&quot;`outfiles` and `infiles` different length&quot;</span>

    <span class="k">elif</span> <span class="n">outdir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span> <span class="s2">&quot;`outdir` should be string&quot;</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">outfiles</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">outprefix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">),</span> \
                <span class="s2">&quot;only specify one of `outfiles`, `outdir`, and `outprefix`&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">outdir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">outdir</span><span class="p">)</span>
        <span class="n">outfiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">infiles</span><span class="p">]</span>

    <span class="k">elif</span> <span class="n">outprefix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">outprefix</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span> <span class="s2">&quot;`outdir` should be string&quot;</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">outfiles</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">outdir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">),</span> \
                <span class="s2">&quot;only specify one of `outfiles`, `outdir`, and `outprefix`&quot;</span>
        <span class="n">outfiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">f</span><span class="p">),</span> <span class="n">outprefix</span> <span class="o">+</span> 
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">))</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">infiles</span><span class="p">]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;specify `outdir`, `outprefix`, `outfiles`&quot;</span><span class="p">)</span>

    <span class="n">outfiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">outfiles</span><span class="p">]</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">outfiles</span><span class="p">))</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">outfiles</span><span class="p">),</span> <span class="s2">&quot;duplicate files in `outfiles`&quot;</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">outfiles</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">infiles</span><span class="p">)),</span> \
            <span class="s2">&quot;some in and outfiles the same&quot;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">fin</span><span class="p">,</span> <span class="n">fout</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">infiles</span><span class="p">,</span> <span class="n">outfiles</span><span class="p">):</span>
        <span class="n">df_in</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fin</span><span class="p">)</span>
        <span class="k">assert</span> <span class="s1">&#39;site&#39;</span> <span class="ow">in</span> <span class="n">df_in</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="s2">&quot;no `site` column in </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fin</span><span class="p">)</span>
        <span class="n">df_in</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_in</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">missing</span> <span class="o">==</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">df_in</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="nb">set</span><span class="p">(</span><span class="n">renumb</span><span class="p">[</span><span class="s1">&#39;original&#39;</span><span class="p">]):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`missing` is `error`, excess sites in </span><span class="si">{0}</span><span class="s2">&quot;</span>
                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fin</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">missing</span> <span class="o">==</span> <span class="s1">&#39;skip&#39;</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">missing</span> <span class="o">==</span> <span class="s1">&#39;drop&#39;</span><span class="p">:</span>
            <span class="n">df_in</span> <span class="o">=</span> <span class="n">df_in</span><span class="p">[</span><span class="n">df_in</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">renumb</span><span class="p">[</span><span class="s1">&#39;original&#39;</span><span class="p">])]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;invalid `missing` of </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">missing</span><span class="p">))</span>

        <span class="c1"># can&#39;t just use replace below because of this bug:</span>
        <span class="c1"># https://github.com/pandas-dev/pandas/issues/16051</span>
        <span class="n">unmappedsites</span> <span class="o">=</span> <span class="n">df_in</span><span class="p">[</span><span class="o">~</span><span class="n">df_in</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">renumb</span><span class="p">[</span><span class="s1">&#39;original&#39;</span><span class="p">])][</span><span class="s1">&#39;site&#39;</span><span class="p">]</span>
        <span class="n">replacemap</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span>
                <span class="n">renumb</span><span class="p">[</span><span class="s1">&#39;original&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unmappedsites</span><span class="p">),</span>
                <span class="n">renumb</span><span class="p">[</span><span class="s1">&#39;new&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unmappedsites</span><span class="p">)))</span>
        <span class="n">df_in</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_in</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">replacemap</span><span class="p">)</span>

        <span class="n">df_in</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_in</span><span class="p">[</span><span class="n">df_in</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">()]</span>
                      <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;site != &quot;NaN&quot;&#39;</span><span class="p">)</span>
                      <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;site != &quot;nan&quot;&#39;</span><span class="p">)</span>
                      <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;site != &quot;None&quot;&#39;</span><span class="p">)</span>
                      <span class="p">)</span>

        <span class="n">df_in</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">fout</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="codonEvolAccessibility"><a class="viewcode-back" href="../../dms_tools2.utils.html#dms_tools2.utils.codonEvolAccessibility">[docs]</a><span class="k">def</span> <span class="nf">codonEvolAccessibility</span><span class="p">(</span><span class="n">seqs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Accessibility of amino acids by nucleotide mutations.</span>

<span class="sd">    Args:</span>
<span class="sd">        `seqs` (str or list)</span>
<span class="sd">            A single coding sequence or a list of such sequences.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A pandas DataFrame listing all sites in the sequence(s)</span>
<span class="sd">        numbered 1, 2, ..., with columns giving the accessibility</span>
<span class="sd">        of each amino acid by single nucleotide mutations.</span>

<span class="sd">    The accessibility of codon :math:`c` to amino-acid :math:`a`</span>
<span class="sd">    by single-nucleotide mutations is defined as the minimum</span>
<span class="sd">    number of nucleotide mutations needed to generate that</span>
<span class="sd">    amino-acid. </span>

<span class="sd">    For a collection of sequences, we calculate the </span>
<span class="sd">    accessibility as the weighted average of the accessibilities</span>
<span class="sd">    of all codons observed at that site in the collection of</span>
<span class="sd">    sequences.</span>

<span class="sd">    As an example, compute accessibility for one sequence:</span>

<span class="sd">    &gt;&gt;&gt; s = &quot;ATGGGA&quot;</span>
<span class="sd">    &gt;&gt;&gt; acc = codonEvolAccessibility(s)</span>

<span class="sd">    The returned pandas DataFrame `acc` is has a column named</span>
<span class="sd">    `site` plus columns for all amino acids:</span>

<span class="sd">    &gt;&gt;&gt; all(acc.columns == [&#39;site&#39;] + AAS_WITHSTOP)</span>
<span class="sd">    True</span>

<span class="sd">    We look at entries for a few amino acids. At the first </span>
<span class="sd">    site, the wildtype entry in the sequence `s` is the codon</span>
<span class="sd">    for *M* (``ATG``). So at this site, the distance to *M*</span>
<span class="sd">    is 0. The distance to *I* (which has codon ``ATA`` as a</span>
<span class="sd">    codon) is 1, and the distance to *W* (which has only ``TGG``</span>
<span class="sd">    as a codon) is 2.</span>

<span class="sd">    &gt;&gt;&gt; acc[[&#39;site&#39;, &#39;G&#39;, &#39;I&#39;, &#39;M&#39;, &#39;W&#39;]]</span>
<span class="sd">       site    G    I    M    W</span>
<span class="sd">    0     1  2.0  1.0  0.0  2.0</span>
<span class="sd">    1     2  0.0  2.0  3.0  2.0</span>

<span class="sd">    If we pass the function a list of multiple sequences,</span>
<span class="sd">    then the accessibilities are averaged over the sequences:</span>

<span class="sd">    &gt;&gt;&gt; acc2 = codonEvolAccessibility([&#39;ATGGGA&#39;, &#39;ATAGGA&#39;])</span>
<span class="sd">    &gt;&gt;&gt; acc2[[&#39;site&#39;, &#39;G&#39;, &#39;I&#39;, &#39;M&#39;, &#39;W&#39;]]</span>
<span class="sd">       site    G    I    M    W</span>
<span class="sd">    0     1  2.0  0.5  0.5  2.5</span>
<span class="sd">    1     2  0.0  2.0  3.0  2.0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># get number of nucleotide diffs between all pairs of codons</span>
    <span class="n">nt_diffs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([</span>
            <span class="p">((</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">),</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">)</span> <span class="k">if</span> <span class="n">x1</span> <span class="o">!=</span> <span class="n">x2</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">CODONS</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="mi">2</span><span class="p">)])</span>

    <span class="c1"># get number of nucleotide diffs to nearest codon for amino acid</span>
    <span class="n">aa_nt_diffs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">CODONS</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">aa</span><span class="p">,</span> <span class="n">othercs</span> <span class="ow">in</span> <span class="n">AA_TO_CODONS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">aa_nt_diffs</span><span class="p">[(</span><span class="n">c</span><span class="p">,</span> <span class="n">aa</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">nt_diffs</span><span class="p">[(</span><span class="n">c</span><span class="p">,</span> <span class="n">c2</span><span class="p">)]</span> 
                    <span class="k">for</span> <span class="n">c2</span> <span class="ow">in</span> <span class="n">othercs</span><span class="p">])</span>

    <span class="c1"># make sure seqs are of same valid length</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">seqs</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">seqs</span> <span class="o">=</span> <span class="p">[</span><span class="n">seqs</span><span class="p">]</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">seqs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;seqs not of length divisible by 3&quot;</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">seqs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">seqs</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="p">]]),</span> \
            <span class="s2">&quot;seqs not all of same length&quot;</span>

    <span class="c1"># get nucleotide distances, summing for all sequences</span>
    <span class="n">dists</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">float</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">seqs</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">//</span> <span class="mi">3</span><span class="p">):</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="n">r</span> <span class="p">:</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">r</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span>
            <span class="k">assert</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">CODONS</span><span class="p">,</span> <span class="s2">&quot;invalid codon </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">AAS_WITHSTOP</span><span class="p">:</span>
                <span class="n">dists</span><span class="p">[</span><span class="n">r</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="n">aa</span><span class="p">]</span> <span class="o">+=</span> <span class="n">aa_nt_diffs</span><span class="p">[(</span><span class="n">c</span><span class="p">,</span> <span class="n">aa</span><span class="p">)]</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">dists</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="s1">&#39;site&#39;</span><span class="p">)</span>
            <span class="p">[</span><span class="n">AAS_WITHSTOP</span><span class="p">]</span>
            <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">seqs</span><span class="p">))</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span></div>


<div class="viewcode-block" id="sigFigStr"><a class="viewcode-back" href="../../dms_tools2.utils.html#dms_tools2.utils.sigFigStr">[docs]</a><span class="k">def</span> <span class="nf">sigFigStr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">nsig</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get str of `x` with `nsig` significant figures.</span>

<span class="sd">    &gt;&gt;&gt; sigFigStr(11190, 2)</span>
<span class="sd">    &#39;11000&#39;</span>
<span class="sd">    &gt;&gt;&gt; sigFigStr(117, 2)</span>
<span class="sd">    &#39;120&#39;</span>
<span class="sd">    &gt;&gt;&gt; sigFigStr(6, 2)</span>
<span class="sd">    &#39;6.0&#39;</span>
<span class="sd">    &gt;&gt;&gt; sigFigStr(0.213, 2)</span>
<span class="sd">    &#39;0.21&#39;</span>
<span class="sd">    &gt;&gt;&gt; sigFigStr(0.007517, 3)</span>
<span class="sd">    &#39;0.00752&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;currently only handles numbers &gt; 0&#39;</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;{{:.</span><span class="si">{nsig}</span><span class="s2">g}}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">nsig</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">predecimal</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">postdecimal</span> <span class="o">=</span> <span class="n">nsig</span> <span class="o">-</span> <span class="n">predecimal</span>
        <span class="k">assert</span> <span class="n">postdecimal</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">f</span><span class="s2">&quot;{{:.</span><span class="si">{postdecimal}</span><span class="s2">f}}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></div>

<div class="viewcode-block" id="getSubstitutions"><a class="viewcode-back" href="../../dms_tools2.utils.html#dms_tools2.utils.getSubstitutions">[docs]</a><span class="k">def</span> <span class="nf">getSubstitutions</span><span class="p">(</span><span class="n">wildtype</span><span class="p">,</span> <span class="n">mutant</span><span class="p">,</span> <span class="n">amino_acid</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get space delimited string of substitutions</span>

<span class="sd">    Args:</span>
<span class="sd">        `wildtype` (str):</span>
<span class="sd">             The wildtype sequence</span>
<span class="sd">        `mutant` (str):</span>
<span class="sd">             The mutant sequence</span>
<span class="sd">        `amino_acid` (bool)</span>
<span class="sd">             Specify whether the sequence is amino acid.</span>
<span class="sd">             Default is False</span>
<span class="sd">    Returns:</span>
<span class="sd">        A space delimited string of substitutions present in the</span>
<span class="sd">        mutant sequence</span>

<span class="sd">    &gt;&gt;&gt; getSubstitutions(&#39;AGT&#39;, &#39;TGT&#39;)</span>
<span class="sd">    &#39;A1T&#39;</span>
<span class="sd">    &gt;&gt;&gt; getSubstitutions(&#39;AAGTAACGA&#39;, &#39;ATCTAACGA&#39;)</span>
<span class="sd">    &#39;A2T G3C&#39;</span>
<span class="sd">    &gt;&gt;&gt; getSubstitutions(&#39;TYARV&#39;, &#39;GYAGV&#39;, amino_acid=True)</span>
<span class="sd">    &#39;T1G R4G&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">wildtype</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mutant</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;wildtype and mutant must be same length&#39;</span><span class="p">)</span>
    <span class="n">subs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wildtype</span><span class="p">)):</span>
        <span class="n">wt</span> <span class="o">=</span> <span class="n">wildtype</span><span class="p">[</span><span class="n">site</span><span class="p">]</span>
        <span class="n">mut</span> <span class="o">=</span> <span class="n">mutant</span><span class="p">[</span><span class="n">site</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">amino_acid</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">wt</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">AAS_WITHSTOP</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span> <span class="p">(</span><span class="n">f</span><span class="s2">&quot;Invalid wt residue </span><span class="si">{wt}</span><span class="s2"> at site {site+1}&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mut</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">AAS_WITHSTOP</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span> <span class="p">(</span><span class="n">f</span><span class="s2">&quot;Invalid mutant residue </span><span class="si">{mut}</span><span class="s2"> at site {site+1}&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">wt</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">NTS</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span> <span class="p">(</span><span class="n">f</span><span class="s2">&quot;Invalid wt nucleotide </span><span class="si">{wt}</span><span class="s2"> at site {site+1}&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mut</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">NTS</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span> <span class="p">(</span><span class="n">f</span><span class="s2">&quot;Invalid mutant nucleotide </span><span class="si">{mut}</span><span class="s2"> at site {site+1}&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">wt</span><span class="o">!=</span><span class="n">mut</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">site</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">subs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;</span><span class="si">{wt}{pos}{mut}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">subs</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">subs</span></div>


<div class="viewcode-block" id="codon_to_nt_counts"><a class="viewcode-back" href="../../dms_tools2.utils.html#dms_tools2.utils.codon_to_nt_counts">[docs]</a><span class="k">def</span> <span class="nf">codon_to_nt_counts</span><span class="p">(</span><span class="n">codoncounts</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert codon counts file to nucleotide counts.</span>

<span class="sd">    Args:</span>
<span class="sd">        `codoncounts` (str or pandas.DataFrame)</span>
<span class="sd">            Codon counts in format produced by ``dms2_bcsubamp``,</span>
<span class="sd">            either as CSV file or data frame holding CSV.</span>

<span class="sd">    Returns:</span>
<span class="sd">        pandas.DataFrame with nucleotide counts.</span>

<span class="sd">    Example:</span>

<span class="sd">    &gt;&gt;&gt; with tempfile.NamedTemporaryFile(&#39;w&#39;) as f:</span>
<span class="sd">    ...     _ = f.write(textwrap.dedent(&#39;&#39;&#39;</span>
<span class="sd">    ...             site,wildtype,AAA,AAC,AAG,AAT,ACA,ACC,ACG,ACT,AGA,AGC,AGG,AGT,ATA,ATC,ATG,ATT,CAA,CAC,CAG,CAT,CCA,CCC,CCG,CCT,CGA,CGC,CGG,CGT,CTA,CTC,CTG,CTT,GAA,GAC,GAG,GAT,GCA,GCC,GCG,GCT,GGA,GGC,GGG,GGT,GTA,GTC,GTG,GTT,TAA,TAC,TAG,TAT,TCA,TCC,TCG,TCT,TGA,TGC,TGG,TGT,TTA,TTC,TTG,TTT</span>
<span class="sd">    ...             1,ATG,0,0,0,0,0,0,2,0,0,0,0,0,8,0,333985,14,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0</span>
<span class="sd">    ...             2,AAG,16,20,333132,41,13,12,27,14,8,6,67,8,9,13,29,9,10,11,12,8,10,15,15,11,6,9,3,7,8,10,17,4,3,7,49,7,9,14,9,4,10,7,7,7,9,11,11,5,14,14,11,6,13,16,15,14,9,9,15,8,9,11,8,15</span>
<span class="sd">    ...             3,GCA,2,3,8,3,34,11,7,6,7,6,9,8,4,3,5,0,6,14,10,12,6,8,7,10,5,11,7,6,6,1,3,12,19,6,11,9,333250,10,6,9,15,3,5,5,37,9,9,7,8,4,8,3,23,5,7,8,6,11,7,10,7,9,3,6 </span>
<span class="sd">    ...             &#39;&#39;&#39;.strip()))</span>
<span class="sd">    ...     f.flush()</span>
<span class="sd">    ...     nt_counts = codon_to_nt_counts(f.name)</span>
<span class="sd">    &gt;&gt;&gt; nt_counts</span>
<span class="sd">       site wildtype       A       C       G       T</span>
<span class="sd">    0     1        A  334009       0       6       0</span>
<span class="sd">    1     2        T       0       2       0  334013</span>
<span class="sd">    2     3        G       8       0  333993      14</span>
<span class="sd">    3     4        A  333424     156     169     187</span>
<span class="sd">    4     5        A  333361     211     186     178</span>
<span class="sd">    5     6        G     156     185  333427     168</span>
<span class="sd">    6     7        G     116     124  333410     125</span>
<span class="sd">    7     8        C     126  333407     121     121</span>
<span class="sd">    8     9        A  333435     114     112     114</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">codoncounts</span><span class="p">,</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">codoncounts</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">codoncounts</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">codoncounts</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;`site` column in `codoncounts` must be integer&#39;</span><span class="p">)</span>

    <span class="n">nt_counts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i_nt</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
        <span class="n">nt_counts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">codoncounts</span>
                <span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">,</span> <span class="s1">&#39;wildtype&#39;</span><span class="p">],</span>
                      <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;codon&#39;</span><span class="p">,</span>
                      <span class="n">value_name</span><span class="o">=</span><span class="s1">&#39;count&#39;</span><span class="p">,</span>
                      <span class="p">)</span>
                <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                    <span class="n">site</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">i_nt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="n">wildtype</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;wildtype&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="n">i_nt</span><span class="p">],</span>
                    <span class="n">nucleotide</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;codon&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="n">i_nt</span><span class="p">],</span>
                    <span class="p">)</span>
                <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;site&#39;</span><span class="p">,</span> <span class="s1">&#39;wildtype&#39;</span><span class="p">,</span> <span class="s1">&#39;nucleotide&#39;</span><span class="p">])</span>
                <span class="o">.</span><span class="n">aggregate</span><span class="p">({</span><span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">})</span>
                <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                <span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="s1">&#39;count&#39;</span><span class="p">,</span>
                             <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;nucleotide&#39;</span><span class="p">,</span>
                             <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">,</span> <span class="s1">&#39;wildtype&#39;</span><span class="p">])</span>
                <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                <span class="p">)</span>

    <span class="n">nt_counts</span> <span class="o">=</span> <span class="p">(</span><span class="n">pandas</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">nt_counts</span><span class="p">)</span>
                 <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;site&#39;</span><span class="p">)</span>
                 <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                 <span class="p">)</span>
    <span class="k">del</span> <span class="n">nt_counts</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">name</span>
    <span class="k">return</span> <span class="n">nt_counts</span></div>


<div class="viewcode-block" id="barcodeInfoToCodonVariantTable"><a class="viewcode-back" href="../../dms_tools2.utils.html#dms_tools2.utils.barcodeInfoToCodonVariantTable">[docs]</a><span class="k">def</span> <span class="nf">barcodeInfoToCodonVariantTable</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">geneseq</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert barcode info files into a CodonVariantTable</span>

<span class="sd">    Convert barcode info files output from `dms2_bcsubamp` into a</span>
<span class="sd">    `CodonVariantTable`. Barcode info files contain reads and barcodes from</span>
<span class="sd">    barcoded subamplicon sequencing, described </span>
<span class="sd">    `here &lt;https://jbloomlab.github.io/dms_tools2/bcsubamp.html&gt;`_.</span>
<span class="sd">    This function takes consensus reads retained by `dms2_bcsubamp`, </span>
<span class="sd">    gives each unique sequence a numerical barcode (since the barcodes from </span>
<span class="sd">    `dms2_bcsubamp` could come from the same variant), and counts the number</span>
<span class="sd">    of retained consensus reads corresponding to each sequence. Then, a</span>
<span class="sd">    `CodonVariantTable` is made using the sequences and their numerical </span>
<span class="sd">    barcodes, and counts are added based on the number of retained consensus</span>
<span class="sd">    reads of those sequences. Therefore, the `CodonVariantTable` will only </span>
<span class="sd">    contain one &#39;variant&#39; for each unique sequence with the total count for all</span>
<span class="sd">    the unbarcoded variants in the experiment which had the same sequence.</span>

<span class="sd">    Args:</span>
<span class="sd">        `samples` (dict):</span>
<span class="sd">            Dictionary with libraries as keys and lists of info file prefixes</span>
<span class="sd">            (file names without the &#39;_bcinfo.txt.gz&#39;) for files corresponding</span>
<span class="sd">            to those libraries as values.</span>
<span class="sd">            </span>
<span class="sd">            Example: {&#39;library-1&#39;:[&#39;condition-1-library-1&#39;],</span>
<span class="sd">                      &#39;library-2&#39;:[&#39;condition-1-library-2&#39;]}</span>
<span class="sd">        `geneseq` (str):</span>
<span class="sd">            The wildtype gene sequence</span>
<span class="sd">        `path` (str)</span>
<span class="sd">            Directory in which barcode info files are located</span>

<span class="sd">    Returns:</span>
<span class="sd">        A `dms_variants.codonvarianttable.CodonVariantTable` with &#39;counts&#39;</span>
<span class="sd">        generated from the barcode info files</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Set up re matchers for looking at lines</span>
    <span class="n">matcher</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?P&lt;linetype&gt;^.*\:) &#39;</span>
                         <span class="sa">r</span><span class="s1">&#39;(?P&lt;contents&gt;.*$)&#39;</span><span class="p">)</span>

    <span class="n">alt_matcher</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?P&lt;linetype&gt;^R\d READS:$)&#39;</span><span class="p">)</span>

    <span class="n">read_matcher</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?P&lt;read&gt;^[ATGCN\s]*$)&#39;</span><span class="p">)</span>

    <span class="c1"># Create a dictionary to contain dictionaries of each library&#39;s barcodes</span>
    <span class="n">libraries</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Initialize lists for making the codonvarianttable</span>
    <span class="n">barcodes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">subs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">variant_call_support</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">library_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># For each library, go through each sample file and collect data</span>
    <span class="k">for</span> <span class="n">library</span> <span class="ow">in</span> <span class="n">samples</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="c1"># Initialize dictionary to contain this library&#39;s reads and barcodes</span>
        <span class="n">barcode_dictionary</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Start a barcode count for this library</span>
        <span class="n">cur_barcode</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c1"># For each barcode info file corresponding to a sample in this library</span>
        <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">samples</span><span class="p">[</span><span class="n">library</span><span class="p">]:</span>

            <span class="c1"># Set initial conditions</span>
            <span class="n">take_next</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">description_skipped</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># Find the file</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;</span><span class="si">{sample}</span><span class="s2">_bcinfo.txt.gz&quot;</span>
            <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
                <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">f</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">file_path</span> <span class="o">=</span> <span class="n">f</span>

            <span class="c1"># Open the file and loop through it to find retained consensus</span>
            <span class="c1"># reads and give them each a new barcode</span>
            <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="c1"># Make sure the first line looks like it is supposed to</span>
                <span class="n">firstline</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                <span class="n">firstline</span> <span class="o">=</span> <span class="n">firstline</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
                <span class="n">first_match</span> <span class="o">=</span> <span class="n">matcher</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">firstline</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">first_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linetype&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;BARCODE:&#39;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Unexpected first line </span><span class="si">{firstline}</span><span class="s2">: may be &quot;</span>
                    <span class="s2">&quot;unexpected file type&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">previous_line</span> <span class="o">=</span> <span class="n">first_match</span>

                <span class="c1"># Go through the lines, making they are in the expected order</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
                    <span class="n">line_match</span> <span class="o">=</span> <span class="n">matcher</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">line_match</span><span class="p">:</span>
                        <span class="n">line_match</span> <span class="o">=</span> <span class="n">alt_matcher</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">line_match</span><span class="p">:</span>
                        <span class="n">read_match</span> <span class="o">=</span> <span class="n">read_matcher</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">read_match</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Unable to recognize line </span><span class="si">{line}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">line_is_read</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">previous_linetype</span> <span class="o">=</span> <span class="n">previous_line</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linetype&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">previous_linetype</span> <span class="o">!=</span> <span class="s1">&#39;R1 READS:&#39;</span> <span class="ow">and</span> \
                               <span class="n">previous_linetype</span> <span class="o">!=</span> <span class="s1">&#39;R2 READS:&#39;</span><span class="p">:</span>
                               <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Unexpected line </span><span class="si">{line}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">line_is_read</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="n">previous_line</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linetype&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;BARCODE:&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">line_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linetype&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;RETAINED:&#39;</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Unexpected line </span><span class="si">{line}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="c1"># Decide whether to retain the next consensus or not</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">line_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;contents&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;False&#39;</span><span class="p">:</span>
                                <span class="n">retain</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">elif</span> <span class="n">line_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;contents&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;True&#39;</span><span class="p">:</span>
                                <span class="n">retain</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Unexpected line </span><span class="si">{line}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">previous_line</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linetype&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;RETAINED:&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">line_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linetype&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;DESCRIPTION:&#39;</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Unexpected line </span><span class="si">{line}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">previous_line</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linetype&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;DESCRIPTION:&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">line_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linetype&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;CONSENSUS:&#39;</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Unexpected line </span><span class="si">{line}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="c1"># Make sure we know whether to retain or not</span>
                        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">retain</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="n">f</span><span class="s2">&quot;Unclear whether to retain {line_match.group(&#39;contents&#39;)}&quot;</span>
                            <span class="p">)</span>
                        <span class="k">elif</span> <span class="n">retain</span><span class="p">:</span>
                            <span class="n">read</span> <span class="o">=</span> <span class="n">line_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;contents&#39;</span><span class="p">)</span>
                            <span class="c1"># Add the read to the dictionary if not in it</span>
                            <span class="c1"># Also give it a barcode</span>
                            <span class="k">if</span> <span class="s1">&#39;N&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">read</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">read</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">barcode_dictionary</span><span class="p">:</span>
                                    <span class="c1"># Create the sequence in the dictionary</span>
                                    <span class="n">barcode_dictionary</span><span class="p">[</span><span class="n">read</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                                    <span class="c1"># Give it an initial count of 1 for this sample</span>
                                    <span class="n">barcode_dictionary</span><span class="p">[</span><span class="n">read</span><span class="p">][</span><span class="n">sample</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                                    <span class="c1"># Give it the next barcode</span>
                                    <span class="n">barcode_dictionary</span><span class="p">[</span><span class="n">read</span><span class="p">][</span><span class="s1">&#39;barcode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur_barcode</span>
                                    <span class="c1"># Save values for making CodonVariantTable</span>
                                    <span class="n">barcodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cur_barcode</span><span class="p">)</span>
                                    <span class="n">subs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">getSubstitutions</span><span class="p">(</span><span class="n">geneseq</span><span class="p">,</span> <span class="n">read</span><span class="p">))</span>
                                    <span class="n">variant_call_support</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                                    <span class="n">library_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">library</span><span class="p">)</span>
                                    <span class="c1"># Advance current barcode</span>
                                    <span class="n">cur_barcode</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="c1"># Add a counter for the sample if sequence</span>
                                    <span class="c1"># not seen for this sample yet</span>
                                    <span class="k">if</span> <span class="n">sample</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">barcode_dictionary</span><span class="p">[</span><span class="n">read</span><span class="p">]:</span>
                                        <span class="n">barcode_dictionary</span><span class="p">[</span><span class="n">read</span><span class="p">][</span><span class="n">sample</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="c1"># Add another count to this read for</span>
                                        <span class="c1"># this sample</span>
                                        <span class="n">barcode_dictionary</span><span class="p">[</span><span class="n">read</span><span class="p">][</span><span class="n">sample</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="c1"># Set retain to None</span>
                        <span class="n">retain</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">elif</span> <span class="n">previous_line</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linetype&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;CONSENSUS:&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">line_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linetype&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;R1 READS:&#39;</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Unexpected line </span><span class="si">{line}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">previous_line</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linetype&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;R1 READS:&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">line_is_read</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">line_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linetype&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;R2 READS:&#39;</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Unexpected line </span><span class="si">{line}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">previous_line</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linetype&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;R2 READS:&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">line_is_read</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">line_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;linetype&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;BARCODE:&#39;</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Unexpected line </span><span class="si">{line}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="c1"># Save this line as the previous line if it is not a read</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">line_is_read</span><span class="p">:</span>
                        <span class="n">previous_line</span> <span class="o">=</span> <span class="n">line_match</span>
        <span class="c1"># After going through each file for a library, save its dictionary with</span>
        <span class="c1"># reads and barcodes</span>
        <span class="n">libraries</span><span class="p">[</span><span class="n">library</span><span class="p">]</span> <span class="o">=</span> <span class="n">barcode_dictionary</span>

    <span class="c1"># Make the dataframe for creating the codonvarianttable</span>
    <span class="n">df</span> <span class="o">=</span>  <span class="p">{</span><span class="s1">&#39;barcode&#39;</span><span class="p">:</span><span class="n">barcodes</span><span class="p">,</span>
            <span class="s1">&#39;substitutions&#39;</span><span class="p">:</span><span class="n">subs</span><span class="p">,</span>
            <span class="s1">&#39;library&#39;</span><span class="p">:</span><span class="n">library_list</span><span class="p">,</span>
            <span class="s1">&#39;variant_call_support&#39;</span><span class="p">:</span><span class="n">variant_call_support</span><span class="p">,</span>
           <span class="p">}</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

    <span class="c1"># Make the codonvarianttable</span>
    <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">variants</span> <span class="o">=</span> <span class="n">dms_variants</span><span class="o">.</span><span class="n">codonvarianttable</span><span class="o">.</span><span class="n">CodonVariantTable</span><span class="p">(</span>
                    <span class="n">barcode_variant_file</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">geneseq</span><span class="o">=</span><span class="n">geneseq</span><span class="p">)</span>

    <span class="c1"># Make the counts dataframe:</span>
    <span class="c1"># Initialize list of dataframes</span>
    <span class="n">dfs</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Loop through each library and produce count dataframes for each sample</span>
    <span class="k">for</span> <span class="n">library</span> <span class="ow">in</span> <span class="n">libraries</span><span class="p">:</span>
        <span class="n">barcode_dictionary</span> <span class="o">=</span> <span class="n">libraries</span><span class="p">[</span><span class="n">library</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">samples</span><span class="p">[</span><span class="n">library</span><span class="p">]:</span>
            <span class="n">barcodes_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">counts_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">sample_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">library_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># Get counts for this sample</span>
            <span class="k">for</span> <span class="n">sequence</span> <span class="ow">in</span> <span class="n">barcode_dictionary</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">sample</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">barcode_dictionary</span><span class="p">[</span><span class="n">sequence</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">counts_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">counts_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">barcode_dictionary</span><span class="p">[</span><span class="n">sequence</span><span class="p">][</span><span class="n">sample</span><span class="p">])</span>
                <span class="n">barcodes_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">barcode_dictionary</span><span class="p">[</span><span class="n">sequence</span><span class="p">][</span><span class="s1">&#39;barcode&#39;</span><span class="p">])</span>
                <span class="n">sample_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>
                <span class="n">library_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">library</span><span class="p">)</span>
            <span class="c1"># Make a dataframe for this sample</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;barcode&#39;</span><span class="p">:</span><span class="n">barcodes_list</span><span class="p">,</span>
                    <span class="s1">&#39;count&#39;</span><span class="p">:</span><span class="n">counts_list</span><span class="p">,</span>
                    <span class="s1">&#39;sample&#39;</span><span class="p">:</span><span class="n">sample_list</span><span class="p">,</span>
                    <span class="s1">&#39;library&#39;</span><span class="p">:</span><span class="n">library_list</span><span class="p">,</span>
                   <span class="p">}</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="c1"># Append it to the list of dataframes</span>
            <span class="n">dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="c1"># Concatenate the list of dataframes into a counts dataframe</span>
        <span class="n">barcode_counts</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">)</span>
    <span class="c1"># Add the counts for each sample to the codonvarianttable</span>
    <span class="k">for</span> <span class="n">library</span> <span class="ow">in</span> <span class="n">libraries</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">samples</span><span class="p">[</span><span class="n">library</span><span class="p">]:</span>
            <span class="n">icounts</span> <span class="o">=</span> <span class="n">barcode_counts</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;library == @library &amp; sample == @sample&#39;</span><span class="p">)</span>
            <span class="n">icounts</span> <span class="o">=</span> <span class="n">icounts</span><span class="p">[[</span><span class="s1">&#39;barcode&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">]]</span>
            <span class="n">variants</span><span class="o">.</span><span class="n">addSampleCounts</span><span class="p">(</span><span class="n">library</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="n">icounts</span><span class="p">)</span>

    <span class="k">return</span><span class="p">(</span><span class="n">variants</span><span class="p">)</span></div>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">doctest</span>
    <span class="n">doctest</span><span class="o">.</span><span class="n">testmod</span><span class="p">()</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../index.html">
    <img class="logo" src="../../_static/BloomLogo.jpg" alt="Logo"/>
    
    <h1 class="logo logo-name">dms_tools2</h1>
    
  </a>
</p>



<p class="blurb">Tools for analyzing deep mutational scanning data.</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=jbloomlab&repo=dms_tools2&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





    

<p>
<a class="badge" href="https://travis-ci.org/jbloomlab/dms_tools2">
    <img
        alt="https://secure.travis-ci.org/jbloomlab/dms_tools2.svg?branch=master"
        src="https://secure.travis-ci.org/jbloomlab/dms_tools2.svg?branch=master"
    />
</a>
</p>


<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bcsubamp.html">Barcoded-subamplicon sequencing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../prefs.html">Amino-acid preferences</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../diffsel.html">Differential selection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fracsurvive.html">Fraction surviving</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../programs.html">Executable programs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">Python API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../citations.html">Citations</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017--2019, the Bloom lab.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.2.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    
    <a href="https://github.com/jbloomlab/dms_tools2" class="github">
        <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"  class="github"/>
    </a>
    

    
  </body>
</html>